<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>メモリア検索（実装日付き・memoria.json対応）</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151935; --text:#e9ecff; --muted:#aab0d6; --line:#2a2f55; --accent:#6ea8ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#0b0f1f;border-bottom:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 14px}
  h1{margin:0;font-size:18px}
  .toolbar{display:grid;gap:8px;grid-template-columns:1fr 150px 150px 100px}
  .toolbar input,.toolbar select,button{height:34px;border:1px solid var(--line);border-radius:8px;background:#0b0f29;color:var(--text);padding:0 10px;font-size:14px}
  .counts{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#0a0e25;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:#c8d2ff}
  .list{max-width:1100px;margin:12px auto;padding:0 14px;display:grid;gap:8px}
  .card{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:start;background:#111430;border:1px solid #262c60;border-radius:12px;padding:10px}
  .thumb{width:56px;height:56px;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#0b0f29}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .meta{line-height:1.25}
  .name{font-weight:700}
  .sub{color:var(--muted);font-size:12px;margin-top:2px}
  .skill{margin-top:6px;font-size:12px;color:#d9e0ff;background:#0a0e25;border:1px solid var(--line);border-radius:8px;padding:6px}
  .skill .title{font-weight:700;margin-right:6px}
  .impl{color:#9fc6ff;font-size:12px;margin-top:4px}
  .copy{background:#17352a;border:1px solid #2a7b57;border-radius:8px;color:#dbffe7;height:32px;padding:0 10px;cursor:pointer}
  .empty{color:var(--muted);padding:20px;text-align:center}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  @media(max-width:720px){.toolbar{grid-template-columns:1fr 1fr 1fr;}.toolbar .right{grid-column:1/-1}}
  /* ===== 左サイド：よく使うスキル ===== */
  .layout{max-width:1100px;margin:12px auto;padding:0 14px;display:grid;grid-template-columns:220px 1fr;gap:12px}
  aside{background:#101432;border:1px solid var(--line);border-radius:12px;padding:10px}
  aside h2{font-size:13px;margin:0 0 8px;color:#cfe0ff}
  #quicklist{display:flex;flex-wrap:wrap;gap:6px}
  .qbtn{border:1px solid #2b3b7a;background:#0b1030;color:#e3e9ff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .qbtn:hover{background:#121846}
  .qrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  #editQuick{height:28px;border:1px solid var(--line);border-radius:8px;background:#0b0f29;color:var(--text);padding:0 8px;font-size:12px}
  @media(max-width:880px){.layout{grid-template-columns:1fr}} 
</style>
</head>
<body>
<footer style="margin-top:40px;padding:20px 0;text-align:center;color:#9aa5da;font-size:14px;border-top:1px solid #2a2f58;background:#0b0f1f;">
  <div style="margin-bottom:6px;color:#cbd3ff;">関連ページリンク</div>
<a href="../../index.html" style="color:#7aa2ff;text-decoration:none;margin:0 8px;">デッキ編成ツール</a> |
  <a href="../../メモリア作成.html" style="color:#7aa2ff;text-decoration:none;margin:0 8px;">メモリア作成</a> |
  <a href="./assets/memoria/memoria.json" style="color:#7aa2ff;text-decoration:none;margin:0 8px;">memoria.json</a>
<header>
  <div class="wrap">
    <h1>メモリア検索（実装日付き）</h1>
    <div class="toolbar">
      <input id="q" type="text" placeholder="名前・スキル（本文）で検索…" />
      <select id="attr">
        <option value="ALL">属性: ALL</option>
        <option>火</option><option>水</option><option>風</option><option>光</option><option>闇</option>
      </select>
      <select id="role">
        <option value="ALL">種別: ALL</option>
        <option>通常前衛</option><option>特殊前衛</option>
        <option>支援</option><option>妨害</option><option>回復</option>
      </select>
      <button id="clear" class="right" title="検索条件をクリア">条件クリア</button>
    </div>
    <div class="counts" id="counts"></div>
    <div class="hint">同フォルダに <code>data.json</code> と <code>icons/</code>（画像）を配置してください。フィールドは <b>name</b> / <b>role</b> / <b>skill_name</b> / <b>skill_desc</b> / <b>implemented</b>（実装日）を使用します。</div>
  </div>
</header>

<div class="layout">
  <aside>
    <div class="qrow">
      <h2>よく使うスキル</h2>
      <button id="editQuick" title="リストを編集">編集</button>
    </div>
    <div id="quicklist"></div>
    <div class="hint">クリックで <b>コピー＆検索</b> します。</div>
  </aside>
  <main>
    <div id="list" class="list"><div class="empty">読み込み中…</div></div>
  </main>
</div>

<script>
(function(){
  const DATA_JSON = './data.json';
  const ICON_DIR  = './icons/';
  const DETAIL_DIR = './details/'; // 詳細画像フォルダ
  let DATA = [];
  const $ = (s)=>document.querySelector(s);
  const listEl = $('#list');
  const esc = (s)=>String(s==null?"":s).replace(/[&<>"]'/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  function card(m){
    const img = `<div class="thumb"><img loading="lazy" decoding="async" src="${ICON_DIR + esc(m.icon||'missing.png')}" alt="${esc(m.name||'memoria')}" onerror="this.src='${ICON_DIR}_fallback.png'"/></div>`;
    const skillBox = (m.skill_name||m.skill_desc)
      ? `<div class="skill"><span class="title">${esc(m.skill_name||'')}</span><span>${esc(m.skill_desc||'')}</span></div>`
      : '';
    const impl = m.implemented
      ? `<div class="impl">実装日: ${esc(m.implemented)}</div>`
      : '';
    const btn = `<button class="copy" data-name="${esc(m.name||'')}">コピー</button>`;
    return `
      <div class="card" data-id="${m.id||''}">
        ${img}
        <div class="meta">
          <div class="name">${esc(m.name||'(名称なし)')}</div>
          <div class="sub">種別: ${esc(m.role||'不明')}／属性: ${esc(m.attr||'不明')}</div>
          ${impl}
          ${skillBox}
        </div>
        ${btn}
      </div>
    `;
  }

  function renderCounts(items){
    const root = $('#counts');
    const by = (key)=> items.reduce((a,x)=>{const k=x[key]||'不明';a[k]=(a[k]||0)+1;return a;},{}); 
    const chips = [];
    const add = (label, obj)=>{const txt = Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}:${v}`).join(' / ') || 'なし:0';chips.push(`<span class="chip">${label} ${txt}</span>`);};
    add('総数', {件数: items.length});
    add('属性', by('attr'));
    add('種別', by('role'));
    root.innerHTML = chips.join('');
  }

  function applyFilter(){
    const q = $('#q').value.trim().toLowerCase();
    const attr = $('#attr').value;
    const role = $('#role').value;
    const filtered = DATA.filter(m=>{
      if(attr!=='ALL' && m.attr!==attr) return false;
      if(role!=='ALL' && m.role!==role) return false;
      if(q && !(m._hay || '').includes(q)) return false;
      return true;
    });
    renderCounts(filtered);
    if(!filtered.length){ listEl.innerHTML = '<div class="empty">該当なし</div>'; return; }
    listEl.innerHTML = filtered.map(card).join('');
  }
  const applyFilterDebounced = debounce(applyFilter, 120);

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.copy');
    if(!btn) return;
    const name = btn.getAttribute('data-name')||'';
    navigator.clipboard.writeText(name).then(()=>{
      btn.textContent = 'コピー済';
      setTimeout(()=>btn.textContent='コピー', 800);
    });
  });

  async function loadData(){
    try{
      const res = await fetch(DATA_JSON, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      DATA = await res.json();
    }catch(e){
      if(Array.isArray(window.MEMORIA_DATA)){
        DATA = window.MEMORIA_DATA;
      }else{
        document.getElementById('list').innerHTML = '<div class="empty">memoria.json を読み込めませんでした。</div>';
        console.error('メモリア読み込み失敗', e);
        return;
      }
    }
    DATA.forEach(m=>{m._hay = [m.name,m.skill_name,m.skill_desc,m.implemented].map(x=>String(x||'').toLowerCase()).join('\n');});
    window.DATA = DATA;
    applyFilter();
  }

  document.addEventListener('input', (e)=>{if(['q','attr','role'].includes(e.target.id)) applyFilterDebounced();});
  document.getElementById('clear').addEventListener('click', ()=>{$('#q').value=''; $('#attr').value='ALL'; $('#role').value='ALL'; applyFilter();});

  // ====== クイックリスト ======
  const QUICK_KEY = 'memoria.quickSkills';
  const DEFAULT_QUICK = ["アニマ","ヴァース","ルミナス","エーテル","エンハンス","エデン","エンハンシア","カウンター","ミニマ","メテオ","コメット","グロリア","バリア","スプレッド","パワーフォール","トライ","リカバー","ガードブレイク","ガードバースト","ブースト","ワイドフォール","範囲+","ワイドアシスト"];
  function getQuick(){
    try{ const arr = JSON.parse(localStorage.getItem(QUICK_KEY)||'[]'); return Array.isArray(arr)&&arr.length?arr:DEFAULT_QUICK; }catch{return DEFAULT_QUICK}
  }
  function setQuick(arr){ localStorage.setItem(QUICK_KEY, JSON.stringify(arr)); }
  function renderQuick(){
    const box = document.getElementById('quicklist');
    const items = getQuick();
    box.innerHTML = items.map(s=>`<button class="qbtn" data-skill="${esc(s)}">${esc(s)}</button>`).join('');
  }
  document.getElementById('quicklist').addEventListener('click', (e)=>{
    const btn = e.target.closest('.qbtn');
    if(!btn) return;
    const s = btn.getAttribute('data-skill');
    document.getElementById('q').value = s;
    navigator.clipboard.writeText(s).catch(()=>{});
    applyFilter();
    const old = btn.textContent; btn.textContent = 'コピー＆検索'; setTimeout(()=>btn.textContent=old, 700);
  });
  document.getElementById('editQuick').addEventListener('click', ()=>{
    const cur = getQuick().join(', ');
    const inp = prompt('よく使うスキルをカンマ区切りで入力', cur);
    if(inp==null) return;
    const arr = inp.split(',').map(s=>s.trim()).filter(Boolean);
    if(arr.length){ setQuick(arr); renderQuick(); }
  });

  // 起動順：まずデータ、続いてクイック描画
  loadData();
  renderQuick();

  // ===== メモリア名 or 画像クリック → モーダルで詳細画像表示 =====
  document.addEventListener('click', (e)=>{
    const cardEl = e.target.closest('.card');
    if(!cardEl) return;

    const nameEl = cardEl.querySelector('.name');
    const imgEl  = cardEl.querySelector('img');
    if(e.target !== nameEl && e.target !== imgEl) return;

    const idStr = cardEl.getAttribute('data-id') || '';
    const item =
      (window.DATA || []).find(m => String(m.id) === idStr) ||
      (window.DATA || []).find(m => m.name === (nameEl?.textContent || '').trim());
    if(!item) return console.warn('対象メモリアが見つからないよ');

    if(!item.detail){
      alert('このメモリアには詳細画像がありません。');
      return;
    }

    let modal = document.getElementById('detailModal');
    if(modal) modal.remove();

    modal = document.createElement('div');
    modal.id = 'detailModal';
    modal.innerHTML = `
      <div class="overlay" style="
        position:fixed;inset:0;background:rgba(0,0,0,0.8);
        display:flex;align-items:center;justify-content:center;
        z-index:10000;backdrop-filter:blur(2px);
        animation:fadeIn .2s ease;">
        <div class="box" style="max-width:90%;max-height:90%;position:relative;">
          <img id="detailImg" src="${DETAIL_DIR + item.detail}" 
               alt="${(nameEl?.textContent || '').trim()} の詳細画像"
               style="max-width:100%;max-height:100%;border-radius:10px;
                      box-shadow:0 0 20px #000;animation:zoomIn .2s ease;">
          <div id="detailClose" style="
            position:absolute;top:-40px;right:0;background:#333;
            color:#fff;padding:6px 12px;border-radius:6px;
            cursor:pointer;font-size:14px;">✕ 閉じる</div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#detailClose').addEventListener('click', ()=> modal.remove());
    modal.querySelector('.overlay').addEventListener('click', (ev)=>{
      if(ev.target.classList.contains('overlay')) modal.remove();
    });
  });

  // アニメーション
  const style = document.createElement('style');
  style.textContent = `
  @keyframes fadeIn {from{opacity:0}to{opacity:1}}
  @keyframes zoomIn {from{transform:scale(.9)}to{transform:scale(1)}}
  `;
  document.head.appendChild(style);

})();
</script>


</body>
</html>
